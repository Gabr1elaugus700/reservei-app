generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model WeeklyCapacity {
    id        String   @id @default(cuid())
    // Dias da semana (0 = Domingo, 1 = Segunda, etc.)
    dayOfWeek Int // 0-6
    limit     Int
    enabled   Boolean  @default(true)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([dayOfWeek])
}

model SpecialDateCapacity {
    id          String   @id @default(cuid())
    date        DateTime @db.Date
    limit       Int
    description String?
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    @@unique([date])
}

model User {
    id            String    @id @default(cuid())
    name          String
    email         String    @unique
    emailVerified Boolean   @default(false)
    image         String?
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt
    sessions      Session[]
    accounts      Account[]

    members     Member[]
    invitations Invitation[]

    @@map("user")
}

model Session {
    id        String   @id @default(cuid())
    expiresAt DateTime
    token     String   @unique
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    ipAddress String?
    userAgent String?
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    activeOrganizationId String?

    @@map("session")
}

model Account {
    id                    String    @id @default(cuid())
    accountId             String
    providerId            String
    userId                String
    user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    accessToken           String?
    refreshToken          String?
    idToken               String?
    accessTokenExpiresAt  DateTime?
    refreshTokenExpiresAt DateTime?
    scope                 String?
    password              String?
    createdAt             DateTime  @default(now())
    updatedAt             DateTime  @updatedAt

    @@map("account")
}

model Verification {
    id         String   @id @default(cuid())
    identifier String
    value      String
    expiresAt  DateTime
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    @@map("verification")
}

model Organization {
    id          String       @id
    name        String
    slug        String
    logo        String?
    createdAt   DateTime
    metadata    String?
    members     Member[]
    invitations Invitation[]

    @@unique([slug])
    @@map("organization")
}

model Member {
    id             String       @id
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    userId         String
    user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
    role           String
    createdAt      DateTime

    @@map("member")
}

model Invitation {
    id             String       @id
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    email          String
    role           String?
    status         String
    expiresAt      DateTime
    inviterId      String
    user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

    @@map("invitation")
}

model Customer {
    id        String   @id @default(cuid())
    name      String
    email     String?  @unique
    phone     String?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    bookings Booking[]
}

model Booking {
    id         String        @id @default(cuid())
    customerId String
    customer   Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
    date       DateTime      @db.Date
    time       String // e.g., "14:00"
    status     BookingStatus @default(PENDING)
    notes      String?
    adults     Int
    children   Int
    totalPrice Decimal?      @db.Decimal(10, 2)

    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt
    timeSlot   TimeSlot @relation(fields: [timeSlotId], references: [id], onDelete: Restrict)
    timeSlotId String

    @@index([date])
}

enum BookingStatus {
    PENDING
    CONFIRMED
    CANCELLED
    COMPLETED
}

// Table to Config general settings
model AvailabilityConfig {
    id String @id @default(cuid())

    dayOfWeek Int? // 0=Domingo ... 6=Sábado
    date      DateTime? @db.Date // se definido, substitui dayOfWeek

    startTime           String // "09:00"
    endTime             String // "18:00"
    slotDurationMinutes Int     @default(30) // minutos entre slots
    capacityPerSlot     Int     @default(20) // capacidade por slot
    isException         Boolean @default(false) // se true, substitui configurações regulares
    isActive            Boolean @default(true)

    // Períodos de pausa (JSON array)
    breakPeriods Json @default("[]")

    timeSlots TimeSlot[]
    createdAt DateTime   @default(now())
    updatedAt DateTime   @updatedAt
}

model TimeSlot {
    id                   String  @id @default(cuid())
    availabilityConfigId String?

    dayOfWeek Int? // 0-6 para slots regulares
    date      DateTime? @db.Date // data específica para exceções

    startTime String // "09:00"
    endTime   String // "18:00"

    totalCapacity     Int     @default(1) // capacidade total do slot
    availableCapacity Int     @default(1) // capacidade disponível
    isAvailable       Boolean @default(true)

    availabilityConfig AvailabilityConfig? @relation(fields: [availabilityConfigId], references: [id], onDelete: Cascade)
    bookings           Booking[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([dayOfWeek, startTime])
    @@index([date, startTime])
}

model LastConfigSync {
    id       String   @id @default(cuid())
    syncedAt DateTime @default(now())
}
